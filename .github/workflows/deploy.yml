name: Deploy to Fly.io

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write
  issues: write

env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

jobs:
  deploy:
    name: Deploy app
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true

    steps:
      - uses: actions/checkout@v4

      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Determine deployment environment
        id: deployment-env
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "app_name=openvibe" >> $GITHUB_OUTPUT
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "is_production=true" >> $GITHUB_OUTPUT
          else
            # For PRs and feature branches, create a unique app name using the reusable script
            branch_name="${{ github.head_ref || github.ref_name }}"
            app_name=$(./.github/scripts/get-app-name.sh "$branch_name")
            echo "app_name=$app_name" >> $GITHUB_OUTPUT
            echo "environment=preview" >> $GITHUB_OUTPUT
            echo "is_production=false" >> $GITHUB_OUTPUT
          fi

      - name: Create fly.toml for feature deployment
        if: steps.deployment-env.outputs.is_production == 'false'
        run: |
          cp fly.toml fly-feature.toml
          sed -i "s/app = 'openvibe'/app = '${{ steps.deployment-env.outputs.app_name }}'/" fly-feature.toml

      - name: Create app for feature environment
        if: steps.deployment-env.outputs.is_production == 'false'
        run: |
          # Create the app if it doesn't exist
          flyctl apps create ${{ steps.deployment-env.outputs.app_name }} --org personal || true
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Create volumes for production
        if: steps.deployment-env.outputs.is_production == 'true'
        run: |
          # Create volumes if they don't exist (ignore errors if they already exist)
          flyctl volume create data_volume -r ewr -n 2 -a ${{ steps.deployment-env.outputs.app_name }} || true
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Set secrets
        run: |
          flyctl secrets set RUNTIME_API_STAGING_SECRET="${{ secrets.RUNTIME_API_STAGING_SECRET }}" -a ${{ steps.deployment-env.outputs.app_name }}
          flyctl secrets set BASIC_AUTH_PASSWORD="${{ secrets.BASIC_AUTH_PASSWORD }}" -a ${{ steps.deployment-env.outputs.app_name }}
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Deploy to production
        if: steps.deployment-env.outputs.is_production == 'true'
        run: flyctl deploy --remote-only
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Deploy to feature environment
        if: steps.deployment-env.outputs.is_production == 'false'
        run: |
          # Deploy using the feature-specific config
          flyctl deploy --config fly-feature.toml --remote-only
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Get deployment URL
        id: deployment-url
        run: |
          echo "url=https://${{ steps.deployment-env.outputs.app_name }}.fly.dev" >> $GITHUB_OUTPUT

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: KeisukeYamashita/create-comment@v1
        with:
          comment: |
            ## ðŸš€ Deployment Status
            
            **Environment:** `${{ steps.deployment-env.outputs.environment }}`
            **App Name:** `${{ steps.deployment-env.outputs.app_name }}`
            **Status:** âœ… Successfully deployed
            
            ### ðŸ”— Preview URL
            **[Visit deployment â†’](${{ steps.deployment-url.outputs.url }})**
            
            ### ðŸ“Š Fly.io Management
            - **[View App Status â†’](https://fly.io/apps/${{ steps.deployment-env.outputs.app_name }})**
            - **[View Metrics â†’](https://fly.io/apps/${{ steps.deployment-env.outputs.app_name }}/metrics)**
            - **[View Monitoring â†’](https://fly.io/apps/${{ steps.deployment-env.outputs.app_name }}/monitoring)**
            
            ---
            
            This deployment will be automatically cleaned up when the PR is closed.
            
            <sub>Deployed via GitHub Actions â€¢ [View workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})</sub>
          unique: true